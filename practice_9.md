# 9 コントローラーによるデータの扱い
## 9.1 コントローラーとデータの入出力
### 学習前 練習問題
1.コントローラーが扱うパラメーターの役割を説明し、どのようなものがあるかを具体的に説明してください。  
  ステートレスな環境において、データを保持させる役割。

2.アクションがHTTPレスポンスを返すときに、通常実行する機能について説明してください。  
  render。ビューテンプレートを返す。

3.renderとredirect_toの共通の役割と違いについて説明してください。  
  次につなげることが共通の役割。違いはrenderはビューテンプレートの表示であって、HTTPレスポンスとして終了するが、redirect_toはHTTPリクエストはシド発行する。

4.ストロングパラメーター化は、どういう目的で行うものなのかを説明してください。  
  わからない。

7.Reservationアプリケーションのroomsコントローラーのindex/new/show/editなどのアクションの中に、renderメソッドが定義されていないにも関わらずビューテンプレートが正しく呼ばれ、出力される理由を説明してください。  
  ActionController::Baseで定義されているため、それらはそのクラスを継承している各コントローラーであるから。

8.ステートレスな通信とセッション情報の役割を説明してください。  
  セッション情報の役割はステートレスな通信において、データを保持させる役割がある。

9.セッション情報はどのように使用するものなのかを説明してください。  
  ログインしているユーザーの情報を保持させたりする。4KBまで。

10.セッション情報とクッキーの関係を説明してください。  
  わかりません。

### コントローラーが扱うパラメーター
- フォームパラメーター:request_parameters  
  - 入力データ
- ルートパラメーター:path_parameters  
  - URIに埋め込まれる:idなどの情報
- クエリパラメーター:query_parameters  
  - 問い合わせなどにしようされるURIの?以降のage=24などの(パラメーター＝値)情報

### ストロングパラメーターの役割
マスアサインメントというセキュリティの脆弱性を回避するための手段  
マスアサインメントとは、クライアントから受け取ったparamsハッシュのフォームパラメーターをそのまま一括指定して、受け取ったデータのモデルオブジェクトを自動で生成する機能。  
便利だが、不正な属性などがあるとそのまま取り込まれてしまうため、ストロングパラメーター化する必要がある。  

### ストロングパラメーター化とは？
マスアサインメントを防ぐため、データの保存処理などを行う前に、保存の対象となる属性値を含むパラメーターに対して許可処理を行うこと。  
そうすることによって、ホワイトリスト上にないパラメーターを無視させることができる。  

### ストロングパラメーター化の方法

paramsハッシュのrequireメソッドとpermitメソッドを組み合わせて行う。

- requireメソッド：対象パラメーターグループの要求  
- permitメソッド：個々のパラメーターの許可を与えるホワイトリストの指定  
  
### renderメソッドについて
指定されたルールに基づいて対応するビューテンプレートを呼び出し、それをもとに、アクション内で指示されたインスタンス変数の値などを使ってHTMLを生成する。  
1回のアクション処理の実行において、renderメソッドは1回だけ実行される。(複数の場合 AbstractController::DoubleRenderError例外)  

renderは「newアクションに相当するビューを実行する」という意味であり、「newアクションを実行する」という意味ではない。

### レンダリング
ビューの出力を支持する作業。

### renderなし
Railsは明示的に記述しなくても、アクション名に相当するビューテンプレート（erbファイル）を探し出し、そのrenderメソッドを暗黙的に実行する。  
アクションと異なる名前のビューをレンダリングしたい場合は、renderの引数として、ビューの名前を指示する。

### renderメソッドのオプション
- :action(省略可)
  - 役割  
    - 同じコントローラーないの他のアクションのテンプレートを出力する場合に指定する
  - 例  
    - `render action: :index`
    もしくは  
    - `render :index`

- :template(省略可)
  - 役割  
    - 異なるコントローラーのディレクトリ下のテンプレートを指定して出力する
  - 例  
    - `render template: 'users/index'`
    もしくは  
    - `render 'users/index'`

### ビューテンプレートを使用しない
- ビューデザインに基づくテンプレートまでは必要としない
- 簡単に結果を送信したい
- 動的に構成したビューを出力したい

> renderメソッドの、plain/html/inlineの3種のオプションを使う

### redirect_toメソッド
コントローラーのアクション内で使用する、アクション実行後に他のルートへリダイレクトを行うためのメソッド

### redirect_toのオプション
- notice:メッセージ  
  通知メッセージ
- alert:メッセージ  
  警告メッセージ
- flash:{キー:値}  
  任意のハッシュパラメーターを使って、値をわたす。  
  flash: {alert: message}  
   => <%= flash[alert] %>  
  より簡略化してか記述できるのがnoticeやalert

### セッション情報の制御とクッキーの利用

Webアプリケーションはステートレスである。  
ステートフルにするための仕組みがセッション。  
- 使用  
`session[:キー] = 値`  
- 削除  
`session[:キー] = nil`もしくは`session.delete(:キー)`

### セッション情報の保存場所
保存場所を**セッションストア**という。  
セッション情報はデフォルトではクッキーに保存される。  
クッキーとは、クライアントのWebブラウザーと簡単な情報をやり取りするためのファイル  

> セッションストアは3種類指定できる

- クッキーストア  クライアントのWebブラウザー内のメモリ
- キャッシュストア  サーバーのキャッシュメモリ
- Active Recordストア  データベースのsessionテーブル

> デフォルトはクッキーストア。他にもサーバーのキャッシュメモリやデータベースのsessionテーブルに作成させる方法もあるが、それぞれ手動で設定が必要。

### セッションストアの違いによる管理
デフォルトでは、IDと暗号化されたデータがクッキーに保存される。
キャッシュストアとActiveRecordストアではセッションIDのみがクッキーに保存され、データ自体はそれぞれの空間にある。

### 学習後 練習問題
1.コントローラーが扱うパラメーターの役割を説明し、どのようなものがあるかを具体的に説明してください。  
  - 解答

  - 正解

2.アクションがHTTPレスポンスを返すときに、通常実行する機能について説明してください。  
  - 解答

  - 正解

3.renderとredirect_toの共通の役割と違いについて説明してください。  
  - 解答

  - 正解

4.ストロングパラメーター化は、どういう目的で行うものなのかを説明してください。  
  - 解答

  - 正解

7.Reservationアプリケーションのroomsコントローラーのindex/new/show/editなどのアクションの中に、renderメソッドが定義されていないにも関わらずビューテンプレートが正しく呼ばれ、出力される理由を説明してください。  
  - 解答

  - 正解

8.ステートレスな通信とセッション情報の役割を説明してください。  
  - 解答

  - 正解

9.セッション情報はどのように使用するものなのかを説明してください。  
  - 解答

  - 正解

10.セッション情報とクッキーの関係を説明してください。  
  - 解答

  - 正解

## 9.2 目的に合わせた出力フォーマットの制御
## 9.3 フィルター