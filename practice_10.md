# Action View
Railsにおけるビューの機能を扱うコンポーネント

## HTMLとERBテンプレート
### 学習前 練習問題10.1
1. ビューテンプレートにRubyコードを組み込む際に使う、<% 〜 %>と<%= 〜 %>という2つの方法の違いについて説明してください。  
  HTMLとして表示しない場合は=を入れない。HTMLとして表示させたい場合は、=をつける。  
2. ビューテンプレートのコメントアウトについて、<!-- 〜 -->と<%#= 〜 %>の違いについて説明してください。  
  わからない。

<%=%>これは実行された結果をHTMLに組み込んでHTTPレスポンスのデータとして出力したい場合に使う。

### ERBにおけるRubyのコメントアウト
`<%#= コメント %>`

### 複数業を一括してコメントアウト
1. Rubyの条件分として、一括して`<% if false %> ~ <% end %>`のように囲む
2. =beginと=endで囲む

```ruby
<%
=begin
%>
comment.comment.comment.comment.comment.comment.
comment.comment.comment.comment.comment.comment.
<%
=end
%>
```

> `<!---->`だとhtmlには変換されるので、ソースコードから見れる。

### 特殊文字をエスケープさせない方法
1. <%== 文字列/式 %>のように、2つの=を使う。
2. <%= raw(文字列/式) %>のように、rawメソッドを使う。
3. <%= 文字列/式.html_safe %>のように、html_safeメソッドを使う。

### 学習後 練習問題10.1
1. ビューテンプレートにRubyコードを組み込む際に使う、<% 〜 %>と<%= 〜 %>という2つの方法の違いについて説明してください。  
  - 解答  
    HTMLを生成し、表示したい場合に=を使う。
  - 正解  
    実行された結果をHTMLに組み込んでHTTPレスポンスのデータとして出力したい場合に使う。

1. ビューテンプレートのコメントアウトについて、<!-- 〜 -->と<%#= 〜 %>の違いについて説明してください。  
  - 解答  
    `<!-- comment -->`は、HTMLにおいてのコメントアウト。`<%#= comment %>`はERBにおけるRubyのコメントアウト。
  - 正解
    正解

## レイアウト
### 学習前 練習問題 10.2
1. 個別のレイアウトを指定する場合の、方法とルールを説明してください。
- **解答**  viewsファイルのアクションに相当するビューファイルを編集する。HTMLを使用する。
2. レイアウトを設定する際の、content_forの目的と実際の使い方を具体的に説明してください。
- **解答**  わかりません。

### 大前提
Action Viewは全体で共通するフレームデザインなどを設けており、メインページのみをそれぞれのアクションに対応するように書き換えることで、統一感を出しながら、管理しやすくしている。

### レイアウトの役割
表示するHTMLページの、共通な外枠フレームの部分を切り出して分離することで、共通部分の保守管理を簡単にすること、および統一感、一貫性のあるページ表現構成を実現する役割がある。

#### headタグにある`csrf_meta_tags`について
セキュリティトークンを追加するヘルパーメソッド。  
正当なクライアントか確認するための認証チケット。  
クロスサイトリクエストフォージェリ攻撃対策用に、自動的に挿入される。  

### 動的なレイアウト機構(content_for)
> Rails の **DRY** の原則に則る。

=> Libraryアプリケーションにて実装

### 練習問題10.2
1. 個別のレイアウトを指定する場合の、方法とルールを説明してください。
- **解答**  layoutsディレクトリにコントローラー名単数で拡張子はhtml.erbで作成する。
- **正解**  正解。
1. レイアウトを設定する際の、content_forの目的と実際の使い方を具体的に説明してください。
- **解答**  目的はRailsのDRYの原則を遵守し、重複するコードを減らすため。方法はレイアウトに`<%= yield :名前 %>`とし、それぞれ個別のerbファイルにおいて`content_for :名前`とブロックで囲み、ブロック内にhtmlを記述する。
- **正解**  重複をなくし、より柔軟に動的にレイアウトを適用するために、埋め込みビューの条件に対応するyield機能を使って設定する。


## ビューテンプレートの共通部品管理

### 部分テンプレートの利用

#### Q. 部分テンプレートのメリットは？
- **A.**  テンプレートの共通部分を、重複なく一箇所で管理することができることと、親となるテンプレートを見やすく、シンプルにできる。

#### Q. renderメソッドにpartialオプションをつけるとどうなる？
- **A.**  部分テンプレート（パーシャルテンプレート）となる。

#### Q. 部分テンプレートにおける、partialオプションは通常省略ができるが、省略できない時もある。それはどんな時？
- **A.**  ローカル変数を渡すためのlocalsオプションを指定するとき。

#### Q. 部分テンプレートでは親テンプレートで使用しているインスタンスヘンスがあればそのまま部分テンプレートでもインスタンス変数を使うことができるが、部分テンプレートのローカル変数を使用して渡すのがルールとなっている。これはなぜか？
- **A.** 入れ子構造になると受け渡す情報が見にくくなるためルールとなっている。

#### Q. ローカル変数とlocalsオプションは何が違うか？
- **A.** 同じもの。明示的にlocalsオプションを指定したい場合は、partialオプションも明示的に記述する必要がある。  

```ruby
<%= render "users/form",user: @user %>
# 上記と下記は同じ
<%= render partial "users/form",locals: { user: @user } %>
```

#### Q. 部分テンプレートのcollectionオプションは何ができるか？
- **A.** 部分テンプレートの対象となるオブジェクトがインスタンス配列（複数のリソース[例：booksなど]）の場合、配列内の各要素を、`each`メソッドを使わずに一行で記述できる。

#### Q. 部分テンプレートにおけるcollectionオプションの具体的な記述方法は？
- **A.** `<%= render partial "rentals/rental", collection: @book.rentals %>`  
rentalsディレクトリに部分テンプレート`_rental.html.erb`ファイルがあることが前提。

#### Q. 上記のcollectionオプションによる記述方法のもっと簡略化した記述方法は？
- **A.** `<%= render partial: @book.rentals %>`  
上記のコードは部分テンプレート名を省略することで、自動的に部分テンプレートと受け取るローカル変数が決定され、処理が行われる。  
例えば、@book.rentalsのインスタンス配列を提供するメソッドはrentalsという名前だが、その単数系rentalを使用して、部分テンプレートが_rental.html.erb、受け取るローカル変数名がrentalと自動的に決定される。

## ビューヘルパー
### 練習問題 10.4
1. image_tagを使用して画像を表示する場合、相対パスと絶対パスで指定する場合の画像の保存場所の違いを説明してください。  
A. わからない。
2. form_withヘルパーメソッドの役割およびmodelオプションとscopeオプションの使い方の違いを具体的に説明してください。  
A. わからない。
3. fields_forヘルパーメソッドの使い方について説明してください。また、その時のストロングパラメーターとの関係についても説明してください。  
A. わからない。

#### Q. 画像を表示するためのヘルパーメソッドは？
A. image_tag '画像ファイルのパス'[,オプション or HTMLオプション]
#### Q. 画像ファイルのパス指定方法をあげよ。
A. 相対パスで指定する方法とルートからの絶対パスで指定する方法がある。  
相対パスの場合`<%= image_tag 'logo.jpg' %>`のように記述し、app/assets/imagesディレクトリ内にあるものとして参照される。  
絶対パスの場合`<%= image_tag '/logo.jpg' %>`のように`/`から記述し、これはpublicディレクトリの下にあるものとして参照される。
#### Q. 画像のサイズを指定する方法を2つあげよ。
A. widthオプションとheightオプションを使用する方法と、sizeオプションを使用する方法  
widthとheightの場合`width: 300, height: 200`、sizeの場合`size:"300x200"`  
> 画像に対するサイズを指定する場合、縦横を両方指定すると、本来の画像の縦横比が無視されてしまう。  
> そのため、画像サイズの補正をしない限り、通常は、縦/横どちらかのサイズを指定する。  
> しかし実際は`class:'logo_image'`などのようにクラスオプションを使用し、スタイルシートで指定する方がいい。

#### Q. form_withヘルパーメソッドは、どのような時に使うか？
A. クライアントパソコンのブラウザーに、データリソースの入力や編集を行うフォームを生成したい時。

#### Q. form_withヘルパーの第一引数に指定するものとして2種類をあげよ。
A. modelとscope

#### Q. 上記における、modelとscopeの違いを説明してください。
A. モデルに紐づいた入力か否か
- **model**  
特定のモデルリソースを対象にした場合  
モデルに基づく新規登録や編集  
- **scope**  
特定のリソース（モデルなど）と結びつかない入力フォームを生成する場合  
例えば、検索機能など  

#### Q. form_withヘルパーメソッドにおけるlocal: trueとはどういう意味か？
A. 画像のページ単位で同期してサーバーからHTTPレスポンスを受信するオプション。  
未記述もしくはfalseでAjaxとして扱われる。

#### Q. form_withヘルパーメソッドを使用した場合、入力項目の値は、コントローラーのアクションにおいてどのように受け取ることができるか？modelがproduct、name属性を取得する場合で考えなさい。
A. params[:product][:name]

#### Q. modelオプションを使用した場合、宛先のURIを指定しなくてもnewアクションによって生成された新規の画面のデータはcreateアクションにルーティングされ、editアクションによって生成された編集の画面のデータはupdateアクションにルーティングされるのはなぜか？
A. RailsにおけるCoC(設定より規約)の思想に則っており、内部的に指定されるモデルのインスタンスを見て、そのインスタンスがidを持たない新規のインスタンスか、idを持つ既存のインスタンスかに応じて、次の宛先となるURIを自動で推測・生成してくれるから。
> もし、手動で指定したい場合はURLオプションを使用する。

#### Q. フォーム要素ヘルパーメソッドに使えるインスタンスメソッドを確認するには？
A. ActionView::Helpers::FormBuilder.instance_methods

#### Q. 親子関係にあるリソースフルルートを、入れ子状態のルートで設定できるが、form_withメソッドを使う際の記述方法は？下記ルートの場合を考える。

```ruby
resources :users do
  resources :hobbies
end
```

A.上記のようなルートの場合で、hobbyを登録したいときは、それに紐付けたいuserの情報も必要なので、下記のように記述する。

```ruby
<%= form_with(model: [hobby.user, hobby ],local: true) do |form| %>
  # 省略
<% end %>
```

#### Q. フォーム要素のヘルパーメソッドにおいて

##### Q. 単一行のテキストボックスを生成するメソッドは？
A. text_field  例：`<%= form.text_field :name %>`

##### Q. 複数行のテキストボックスを生成するメソッドは？
A. text_area  例：`<%= form.text_area :message %>`

##### Q. 隠しフィールドを生成するには？
A. hidden_field  例：:`<%= form.hidden_field :secret %>`

##### Q. パスワードフィールドを生成するには？
A. password_field  例：`<%= form.password_field :password %>`  
> 入力内容は「*」に置き換えられる。

##### Q. チェックボックスを生成するには？
A. check_box  例：`<%= form.check_box :married %>`

##### Q. モデルのリソースに基づいて、チェックボックスを、リソースの数だけ自動的に生成するには？Langモデルのname属性をチェックボックスの値とし、Langのidをlocaleに取り込む場合。
A. collection_check_boxes  例：`<%= form.collection_check_boxes(:locale, Lang.all, :id, :name) %>`  
<%= form.collection_check_boxes(:取り込む変数名, データリソース（モデル.all など）, :id, :属性値) %>

##### Q. 入力フィールドの項目名を表示するラベルを生成するには？name属性の項目名の場合。
A. label  例：`<%= form.label :name %>`

##### Q. 指定した値に基づいて、ラジオボタンを生成したい場合に使用するメソッドは？
A. radio_button  
例：

```ruby
<% genders = %w(男 女 その他) %>
<% genders.each_with_index do |g,i| %>
  <%= form.label :gender, g, value: i %>
  <%= form.radio_button :gender,i %>
<% end %>
```

<% genders.each_with_index do |g,i| %>
  <%= form.label :属性値, 値, value: インデックス番号 %>
  <%= form.radio_button :属性値, インデックス番号 %>
<% end %>

##### Q. モデルのリソースに基づいて、ラジオボタンを、リソースの数だけ自動的に生成する方法は？
A. collection_radio_buttons  
例：Hobbyモデルのname属性の場合。  

```
<%= form.collection_radio_buttons(:hobby, Hobby.all, :id, :name) %>
```

##### Q. 入力情報をリセットするためのボタンを生成する場合には？
A. button  例：`<%= form.button "リセット", type: :reset %>`

##### Q. ある範囲の数値を入力するためのスライダーを生成したい場合は？最小値は0で、最大値は10、メモリ（刻み）は1とする場合。like_rangeという名前で結果はresultで受け取る。
A. range_field  例：`<%= form.range_field :like_range, min: 0, max: 10, step: 1, id: :result %>`

##### Q.日付を入力させるためのカレンダーダイアログを生成したい場合に使用するメソッドは？
A. date_field  例:`<%= form.date_field :memorial_date %>`

##### Q.年月日の選択フィールドと年月日と時秒分の選択フィールドを生成するメソッドは？
A. date_select/datetime_select  
年月日の例:`<%= form.date_select :birth_day %>`  
年月日と時分秒の例:`<%= form.datetime_select :login_datetime %>`  
> デフォルトは前後5年。オプションで`start_year: 1990`と`end_year: 2000`が指定できる。

##### Q.電話番号の入力フォームヘルパーメソッドは？
A. telephone_field

##### Q.emailの入力フォームヘルパーメソッドは？
A. email_field

##### Q.URLの入力フォームヘルパーメソッドは？
A. url_field

##### Q.項目選択のセレクトボックスを生成するメソッドは？
A. select

##### Q.フォームの送信ボタンを生成するメソッドは？
A. submit

##### Q.検索入力用テキストボックスを生成するメソッドは？
A. search_field

##### Q. 整数値を入力するためのテキストボックスを生成するメソッドは？
A. number_field

#### Q. 名前空間adminで入れ子に設定されているquestionコントローラーに対して、form_withメソッドで新規作成および、編集フォームを作成する方法は？

> 下記、ルートの記述

```ruby
namespace "admin" do
  resources :questions
end
```

A. `<%= form_with(model: [:admin, question], local: true ) do |form| %>`  
form_with(model: [:名前空間名, モデルオブジェクト], local: true ) do |form|

#### Q. 「注文モデルに紐づく注文詳細モデル」の例で、一つのモデルが他のモデルと1対多のアソシエーションの関係にある場合、親モデルの入力フォームの中に、子モデルの属性項目を親モデルの一つの属性グループのように扱い、入れ子上にして組み込んだビューを作成する方法を説明してください。
ヒント：コントローラーとモデル、ビュー全てにおいて設定が必要ですが、追記する項目のみで大丈夫です。  
注文モデルをorder、注文詳細モデルをorder_detailとしてください。  
また、ビューに関しては、パーシャルテンプレートを使用し、_form.html.erbの内容のみ記述してください。  
コントローラーに関してはnewアクションとeditアクションの追記部分のみ解答してください。  
editに必要なidの取得はされているものとします。  
また、注文詳細モデルは1つのみとします。編集時には新たに注文詳細モデルが追加できるようにしてください。  
注文モデルの属性はname,order_date  
注文詳細モデルの属性はid,item_name,countとします。  

A. モデル  

```ruby
# orderモデル
accepts_nested_attributes_for :order_details
```

```ruby
# orderコントローラー
def new
  @order = Order.new
  @order.order_details.new
end

def edit
  @order.order_details.new
end


private
  def order_params
    params.require(:order).permit(:name,
                                  :order_date,
                                  order_details_attributes: [:id,
                                                             :item_name,
                                                             :count]
                                  )
  end
```

#### Q. ビューテンプレートで使用するヘルパーメソッドを独自で作成する方法を2つ挙げなさい。
A. app/helpersディレクトリ下のヘルパーモジュールファイルを使用する方法と、コントローラー内helper_methodメソッドを使用する方法。

### 練習問題 10.4
1. image_tagを使用して画像を表示する場合、相対パスと絶対パスで指定する場合の画像の保存場所の違いを説明してください。
- **解答**  相対パスはapp/assets/imagesディレクトリ、絶対パスはpublicディレクトリ
- **正解**  正解  
相対パスの場合`<%= image_tag 'logo.jpg' %>`のように記述し、app/assets/imagesディレクトリ内にあるものとして参照される。  
絶対パスの場合`<%= image_tag '/logo.jpg' %>`のように`/`から記述し、これはpublicディレクトリの下にあるものとして参照される。  
1. form_withヘルパーメソッドの役割およびmodelオプションとscopeオプションの使い方の違いを具体的に説明してください。
- **解答**  form_withの役割はクライアントからの入力を受け付けるフォームを作成する。modelオプションはモデルに紐づくデータの入力の場合、scopeはモデルに紐づかないデータの入力の場合に使用する。
- **正解**  正解。scopeの使用例として検索機能などが挙げられる。
1. field_forヘルパーメソッドの使い方について説明してください。また、その時のストロングパラメーターとの関係についても説明してください。
- **解答**  field_forは親子関係にあるモデルで使用するメソッドで、親モデルでform_withを使用したブロック内で使用することで、親モデルの属性の一つとして子モデルのデータの入力を受け付けることができる。使用方法は、form_withメソッドでformを引数として、`form.field_for :子モデル名`でform_withと同じように使用できる。ただし、親モデルにおいて、`acept_nested_attributes_for: 子モデル名複数形`と親コントローラーのストロングパラメーターにおいて、属性に`子モデル名複数形_attributes: [:属性名]`で追記する必要がある。
- **正解**  正しくは、`accepts_nested_attributes_for :子モデル名複数形`  
一つのモデルが他のモデルと1対多のアソシエーションの関係にある場合、親モデルの入力フォームの中に、子モデルの属性項目を親モデルの一つの属性グループのように扱い、入れ子上にして組み込んだビューを作成する方法がfield_forを使用したフォーム画面。
